import{O as G,i as D,c as $,n as J,m as T,s as Q,f as Y,l as tt}from"../js/superbased-sdk.js";var et=Array.isArray;function rt(r){return r.length===1&&et(r[0])?r[0]:r}function it(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];return r=rt(r),r.length===1?D(r[0]):new G(nt(r))}function nt(r){return function(t){for(var e=[],n=function(s){e.push(D(r[s]).subscribe($(t,function(a){if(e){for(var o=0;o<e.length;o++)o!==s&&e[o].unsubscribe();e=null}t.next(a)})))},i=0;e&&!t.closed&&i<r.length;i++)n(i)}}function st(r){return r instanceof Uint8Array||ArrayBuffer.isView(r)&&r.constructor.name==="Uint8Array"}function H(r,...t){if(!st(r))throw new Error("Uint8Array expected");if(t.length>0&&!t.includes(r.length))throw new Error("Uint8Array expected of length "+t+", got length="+r.length)}function R(r,t=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(t&&r.finished)throw new Error("Hash#digest() has already been called")}function at(r,t){H(r);const e=t.outputLen;if(r.length<e)throw new Error("digestInto() expects output buffer of length at least "+e)}function v(...r){for(let t=0;t<r.length;t++)r[t].fill(0)}function k(r){return new DataView(r.buffer,r.byteOffset,r.byteLength)}function A(r,t){return r<<32-t|r>>>t}function ot(r){if(typeof r!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(r))}function X(r){return typeof r=="string"&&(r=ot(r)),H(r),r}class ht{}function ut(r){const t=n=>r().update(X(n)).digest(),e=r();return t.outputLen=e.outputLen,t.blockLen=e.blockLen,t.create=()=>r(),t}function lt(r,t,e,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(t,e,n);const i=BigInt(32),s=BigInt(4294967295),a=Number(e>>i&s),o=Number(e&s),c=n?4:0,l=n?0:4;r.setUint32(t+c,a,n),r.setUint32(t+l,o,n)}function ct(r,t,e){return r&t^~r&e}function ft(r,t,e){return r&t^r&e^t&e}class dt extends ht{constructor(t,e,n,i){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=t,this.outputLen=e,this.padOffset=n,this.isLE=i,this.buffer=new Uint8Array(t),this.view=k(this.buffer)}update(t){R(this),t=X(t),H(t);const{view:e,buffer:n,blockLen:i}=this,s=t.length;for(let a=0;a<s;){const o=Math.min(i-this.pos,s-a);if(o===i){const c=k(t);for(;i<=s-a;a+=i)this.process(c,a);continue}n.set(t.subarray(a,a+o),this.pos),this.pos+=o,a+=o,this.pos===i&&(this.process(e,0),this.pos=0)}return this.length+=t.length,this.roundClean(),this}digestInto(t){R(this),at(t,this),this.finished=!0;const{buffer:e,view:n,blockLen:i,isLE:s}=this;let{pos:a}=this;e[a++]=128,v(this.buffer.subarray(a)),this.padOffset>i-a&&(this.process(n,0),a=0);for(let h=a;h<i;h++)e[h]=0;lt(n,i-8,BigInt(this.length*8),s),this.process(n,0);const o=k(t),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=c/4,f=this.get();if(l>f.length)throw new Error("_sha2: outputLen bigger than state");for(let h=0;h<l;h++)o.setUint32(4*h,f[h],s)}digest(){const{buffer:t,outputLen:e}=this;this.digestInto(t);const n=t.slice(0,e);return this.destroy(),n}_cloneInto(t){t||(t=new this.constructor),t.set(...this.get());const{blockLen:e,buffer:n,length:i,finished:s,destroyed:a,pos:o}=this;return t.destroyed=a,t.finished=s,t.length=i,t.pos=o,i%e&&t.buffer.set(n),t}clone(){return this._cloneInto()}}const E=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),gt=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),_=new Uint32Array(64);class pt extends dt{constructor(t=32){super(64,t,8,!1),this.A=E[0]|0,this.B=E[1]|0,this.C=E[2]|0,this.D=E[3]|0,this.E=E[4]|0,this.F=E[5]|0,this.G=E[6]|0,this.H=E[7]|0}get(){const{A:t,B:e,C:n,D:i,E:s,F:a,G:o,H:c}=this;return[t,e,n,i,s,a,o,c]}set(t,e,n,i,s,a,o,c){this.A=t|0,this.B=e|0,this.C=n|0,this.D=i|0,this.E=s|0,this.F=a|0,this.G=o|0,this.H=c|0}process(t,e){for(let h=0;h<16;h++,e+=4)_[h]=t.getUint32(e,!1);for(let h=16;h<64;h++){const u=_[h-15],d=_[h-2],m=A(u,7)^A(u,18)^u>>>3,g=A(d,17)^A(d,19)^d>>>10;_[h]=g+_[h-7]+m+_[h-16]|0}let{A:n,B:i,C:s,D:a,E:o,F:c,G:l,H:f}=this;for(let h=0;h<64;h++){const u=A(o,6)^A(o,11)^A(o,25),d=f+u+ct(o,c,l)+gt[h]+_[h]|0,g=(A(n,2)^A(n,13)^A(n,22))+ft(n,i,s)|0;f=l,l=c,c=o,o=a+d|0,a=s,s=i,i=n,n=d+g|0}n=n+this.A|0,i=i+this.B|0,s=s+this.C|0,a=a+this.D|0,o=o+this.E|0,c=c+this.F|0,l=l+this.G|0,f=f+this.H|0,this.set(n,i,s,a,o,c,l,f)}roundClean(){v(_)}destroy(){this.set(0,0,0,0,0,0,0,0),v(this.buffer)}}const xt=ut(()=>new pt),V=97,U=32,P=16,I={Skip:0,Fingerprint:1,IdList:2};class x{_raw;length;constructor(t){this._raw=new Uint8Array(t||512),this.length=t?t.length:0}unwrap(){return this._raw.subarray(0,this.length)}get capacity(){return this._raw.byteLength}extend(t){if(t instanceof x&&(t=t.unwrap()),typeof t.length!="number")throw Error("bad length");const e=t.length+this.length;if(this.capacity<e){const n=this._raw,i=Math.max(this.capacity*2,e);this._raw=new Uint8Array(i),this._raw.set(n)}this._raw.set(t,this.length),this.length+=t.length}shift(){const t=this._raw[0];return this._raw=this._raw.subarray(1),this.length--,t}shiftN(t=1){const e=this._raw.subarray(0,t);return this._raw=this._raw.subarray(t),this.length-=t,e}}function S(r){let t=0;for(;;){if(r.length===0)throw Error("parse ends prematurely");let e=r.shift();if(t=t<<7|e&127,(e&128)===0)break}return t}function w(r){if(r===0)return new x([0]);let t=[];for(;r!==0;)t.push(r&127),r>>>=7;t.reverse();for(let e=0;e<t.length-1;e++)t[e]|=128;return new x(t)}function mt(r){return O(r,1)[0]}function O(r,t){if(r.length<t)throw Error("parse ends prematurely");return r.shiftN(t)}class bt{buf;sha256;constructor(){this.buf=new Uint8Array(U),this.sha256=async t=>xt.create().update(t).digest()}setToZero(){this.buf=new Uint8Array(U)}add(t){let e=0,n=0,i=new DataView(this.buf.buffer),s=new DataView(t.buffer);for(let a=0;a<8;a++){let o=a*4,c=i.getUint32(o,!0),l=s.getUint32(o,!0),f=c;f+=e,f+=l,f>4294967295&&(n=1),i.setUint32(o,f&4294967295,!0),e=n,n=0}}negate(){let t=new DataView(this.buf.buffer);for(let n=0;n<8;n++){let i=n*4;t.setUint32(i,~t.getUint32(i,!0))}let e=new Uint8Array(U);e[0]=1,this.add(e)}async getFingerprint(t){let e=new x;return e.extend(this.buf),e.extend(w(t)),(await this.sha256(e.unwrap())).subarray(0,P)}}class W{items;sealed;constructor(){this.items=[],this.sealed=!1}insert(t,e){if(this.sealed)throw Error("already sealed");if(e=Z(e),e.byteLength!==U)throw Error("bad id size for added item");this.items.push({timestamp:t,id:e})}seal(){if(this.sealed)throw Error("already sealed");this.sealed=!0,this.items.sort(N);for(let t=1;t<this.items.length;t++)if(N(this.items[t-1],this.items[t])===0)throw Error("duplicate item inserted")}unseal(){this.sealed=!1}size(){return this._checkSealed(),this.items.length}getItem(t){if(this._checkSealed(),t>=this.items.length)throw Error("out of range");return this.items[t]}iterate(t,e,n){this._checkSealed(),this._checkBounds(t,e);for(let i=t;i<e&&n(this.items[i],i);++i);}findLowerBound(t,e,n){return this._checkSealed(),this._checkBounds(t,e),this._binarySearch(this.items,t,e,i=>N(i,n)<0)}async fingerprint(t,e){let n=new bt;return n.setToZero(),this.iterate(t,e,(i,s)=>(n.add(i.id),!0)),await n.getFingerprint(e-t)}_checkSealed(){if(!this.sealed)throw Error("not sealed")}_checkBounds(t,e){if(t>e||e>this.items.length)throw Error("bad range")}_binarySearch(t,e,n,i){let s=n-e;for(;s>0;){let a=e,o=Math.floor(s/2);a+=o,i(t[a])?(e=++a,s-=o+1):s=o}return e}}class wt{storage;frameSizeLimit;lastTimestampIn;lastTimestampOut;isInitiator;wantUint8ArrayOutput;constructor(t,e=0){if(e!==0&&e<4096)throw Error("frameSizeLimit too small");this.storage=t,this.frameSizeLimit=e,this.lastTimestampIn=0,this.lastTimestampOut=0}_bound(t,e){return{timestamp:t,id:e||new Uint8Array(0)}}async initiate(){if(this.isInitiator)throw Error("already initiated");this.isInitiator=!0;let t=new x;return t.extend([V]),await this.splitRange(0,this.storage.size(),this._bound(Number.MAX_VALUE),t),this._renderOutput(t)}setInitiator(){this.isInitiator=!0}async reconcile(t){let e=[],n=[],i=new x(Z(t));this.lastTimestampIn=this.lastTimestampOut=0;let s=new x;s.extend([V]);let a=mt(i);if(a<96||a>111)throw Error("invalid negentropy protocol version byte");if(a!==V){if(this.isInitiator)throw Error("unsupported negentropy protocol version requested: "+(a-96));return[this._renderOutput(s),e,n]}let o=this.storage.size(),c=this._bound(0),l=0,f=!1;for(;i.length!==0;){let h=new x,u=()=>{f&&(f=!1,h.extend(this.encodeBound(c)),h.extend(w(I.Skip)))},d=this.decodeBound(i),m=S(i),g=l,p=this.storage.findLowerBound(l,o,d);if(m===I.Skip)f=!0;else if(m===I.Fingerprint){let L=O(i,P),B=await this.storage.fingerprint(g,p);j(L,B)!==0?(u(),await this.splitRange(g,p,d,h)):f=!0}else if(m===I.IdList){let L=S(i),B={};for(let b=0;b<L;b++){let y=O(i,U);this.isInitiator&&(B[y]=y)}if(this.isInitiator){f=!0,this.storage.iterate(g,p,b=>{let y=b.id;return B[y]?delete B[y]:this.isInitiator&&e.push(this.wantUint8ArrayOutput?y:F(y)),!0});for(let b of Object.values(B))n.push(this.wantUint8ArrayOutput?b:F(b))}else{u();let b=new x,y=0,z=d;this.storage.iterate(g,p,(C,q)=>this.exceededFrameSizeLimit(s.length+b.length)?(z=C,p=q,!1):(b.extend(C.id),y++,!0)),h.extend(this.encodeBound(z)),h.extend(w(I.IdList)),h.extend(w(y)),h.extend(b),s.extend(h),h=new x}}else throw Error("unexpected mode");if(this.exceededFrameSizeLimit(s.length+h.length)){let L=await this.storage.fingerprint(p,o);s.extend(this.encodeBound(this._bound(Number.MAX_VALUE))),s.extend(w(I.Fingerprint)),s.extend(L);break}else s.extend(h);l=p,c=d}return[s.length===1&&this.isInitiator?null:this._renderOutput(s),e,n]}async splitRange(t,e,n,i){let s=e-t,a=16;if(s<a*2)i.extend(this.encodeBound(n)),i.extend(w(I.IdList)),i.extend(w(s)),this.storage.iterate(t,e,o=>(i.extend(o.id),!0));else{let o=Math.floor(s/a),c=s%a,l=t;for(let f=0;f<a;f++){let h=o+(f<c?1:0),u=await this.storage.fingerprint(l,l+h);l+=h;let d;if(l===e)d=n;else{let m,g;this.storage.iterate(l-1,l+1,(p,L)=>(L===l-1?m=p:g=p,!0)),d=this.getMinimalBound(m,g)}i.extend(this.encodeBound(d)),i.extend(w(I.Fingerprint)),i.extend(u)}}}_renderOutput(t){let e=t.unwrap();return this.wantUint8ArrayOutput?e:F(e)}exceededFrameSizeLimit(t){return this.frameSizeLimit&&t>this.frameSizeLimit-200}decodeTimestampIn(t){let e=S(t);return e=e===0?Number.MAX_VALUE:e-1,this.lastTimestampIn===Number.MAX_VALUE||e===Number.MAX_VALUE?(this.lastTimestampIn=Number.MAX_VALUE,Number.MAX_VALUE):(e+=this.lastTimestampIn,this.lastTimestampIn=e,e)}decodeBound(t){let e=this.decodeTimestampIn(t),n=S(t);if(n>U)throw Error("bound key too long");let i=O(t,n);return{timestamp:e,id:i}}encodeTimestampOut(t){if(t===Number.MAX_VALUE)return this.lastTimestampOut=Number.MAX_VALUE,w(0);let e=t;return t-=this.lastTimestampOut,this.lastTimestampOut=e,w(t+1)}encodeBound(t){let e=new x;return e.extend(this.encodeTimestampOut(t.timestamp)),e.extend(w(t.id.length)),e.extend(t.id),e}getMinimalBound(t,e){if(e.timestamp!==t.timestamp)return this._bound(e.timestamp);{let n=0,i=e.id,s=t.id;for(let a=0;a<U&&i[a]===s[a];a++)n++;return this._bound(e.timestamp,e.id.subarray(0,n+1))}}}function Z(r){return typeof r=="string"&&(r=yt(r)),r}function yt(r){if(r.startsWith("0x")&&(r=r.substr(2)),r.length%2===1)throw Error("odd length of hex string");let t=new Uint8Array(r.length/2);for(let e=0;e<t.length;e++)t[e]=parseInt(r.substr(e*2,2),16);return t}const K=new Array(256);{const r=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];for(let t=0;t<256;t++)K[t]=r[t>>>4&15]+r[t&15]}function F(r){let t="";for(let e=0,n=r.length;e<n;e++)t+=K[r[e]];return t}function j(r,t){for(let e=0;e<r.byteLength;e++){if(r[e]<t[e])return-1;if(r[e]>t[e])return 1}return r.byteLength>t.byteLength?1:r.byteLength<t.byteLength?-1:0}function N(r,t){return r.timestamp===t.timestamp?j(r.id,t.id):r.timestamp-t.timestamp}const M=tt.extend("negentropy");async function Et(r,t){const e=new W;for(const n of await r.getByFilters(t))e.insert(n.created_at,n.id);return e.seal(),e}function _t(r){const t=new W;for(const e of r)t.insert(e.created_at,e.id);return t.seal(),t}async function It(r,t,e,n,i){let s=J(),a=new wt(r,i?.frameSizeLimit),o=await a.initiate(),c=o;const l=t.multiplex(()=>(M("Sending initial message",s,e,o),["NEG-OPEN",s,e,o]),()=>(M("Closing sync",s),["NEG-CLOSE",s]),u=>(u[0]==="NEG-MSG"||u[0]==="NEG-ERR")&&u[1]===s).pipe(T(u=>{if(u[0]==="NEG-ERR")throw new Error(u[2]);return u[2]}),Q());if(i?.signal?.aborted)return!1;const f=new G(u=>{if(i?.signal?.aborted){u.next("abort"),u.complete();return}const d=()=>{u.next("abort"),u.complete()};return i?.signal?.addEventListener("abort",d),()=>i?.signal?.removeEventListener("abort",d)}),h=l.subscribe({next:u=>M(u),error:()=>{}});try{for(;c&&i?.signal?.aborted!==!0;)try{const u=await Y(it(l.pipe(T(p=>({type:"message",data:p}))),f.pipe(T(()=>({type:"abort"})))));if(u.type==="abort"||i?.signal?.aborted)return h.unsubscribe(),!1;const[d,m,g]=await a.reconcile(u.data);await n(m,g),c=d}catch(u){if(i?.signal?.aborted)return h.unsubscribe(),!1;throw u}}catch(u){throw h.unsubscribe(),u}finally{h.unsubscribe()}return!0}export{Et as buildStorageFromFilter,_t as buildStorageVector,It as negentropySync};
